# v2.4 更新計劃：RP Type 計算選項

## 需求說明

### 背景
現有系統無論 RP Type 是 ND 或 RF 都會計算 Safety Stock。此版本新增選項讓用戶靈活選擇計算模式，以適應不同的業務需求。

### 計算模式選項

#### 模式 1：計算所有 RP Type（預設）
- 無論 RP Type 為 ND 或 RF，都會執行標準的 Safety Stock 計算公式
- RP Type 缺失或值不符合時，也進行正常計算
- 預設行為，保持向後相容性

#### 模式 2：僅計算 RF 型（新增）
- **RP Type = RF 的商品**：執行標準的 Safety Stock 計算
- **RP Type = ND 的商品**：跳過計算，使用原始 Safety Stock（若存在）或返回 0
- **RP Type 缺失或其他值**：執行標準的 Safety Stock 計算（不受此設定限制）

## 技術實現計劃

### 1. 設定管理 (`config/settings.py` 和 `config/settings.json`)

#### settings.py 修改
新增參數至 `Settings` 類別的 `__init__()` 方法：
```python
def __init__(
    self,
    ...
    calculate_ss_for_all_rp_types: bool = True
):
    """
    參數:
        calculate_ss_for_all_rp_types: 是否計算所有RP Type的Safety Stock
                                       True=計算全部, False=僅計算RF
    """
    self.calculate_ss_for_all_rp_types = calculate_ss_for_all_rp_types
```

更新 `to_dict()` 和 `from_dict()` 方法以支持序列化和反序列化。

#### settings.json 初始化
新增默認設定：
```json
{
  ...
  "calculate_ss_for_all_rp_types": true
}
```

### 2. 計算邏輯修改 (`core/calculator.py`)

在 `calculate_safety_stock()` 方法中新增RP Type檢查邏輯：

```python
# 步驟 0：檢查 RP Type 過濾條件
if not self.settings.calculate_ss_for_all_rp_types:
    rp_type_upper = (rp_type.strip().upper() if rp_type else "").strip()
    if rp_type_upper == "ND":
        # 返回特殊結果：使用原始Safety Stock，標記為「跳過計算」
        return {...特殊結果...}
```

當遇到RP Type = ND 且設定為「僅計算RF」時的返回結果結構：
- `Suggested_Safety_Stock`: 原始Safety Stock值（若無則為0）
- `Constraint_Applied`: "RP Type Filter (ND)"
- `Calculation_Mode`: "Skipped (RP Type=ND)"
- `Notes`: "由於 RP Type = ND，且系統設定為「僅計算 RF」，本行使用原始 Safety Stock = {original_ss}"

### 3. 用戶界面修改 (`app.py`)

#### 設定面板更新
在 `display_settings_panel()` 函數中新增 RP Type 計算選項：

```python
st.sidebar.subheader("RP Type 計算選項")

calculate_ss_for_all_rp_types = st.sidebar.radio(
    "Safety Stock 計算範圍",
    options=[True, False],
    format_func=lambda x: "計算所有 RP Type（ND + RF）" if x else "僅計算 RF 型",
    value=settings.calculate_ss_for_all_rp_types,
    help="選擇是計算所有 RP Type 的 Safety Stock，還是僅計算 RF 型的 Safety Stock"
)
```

#### 幫助信息
當用戶選擇「僅計算 RF 型」時，顯示說明文字：
```
ℹ️ **RP Type 過濾說明**

選擇「僅計算 RF 型」時：
• RP Type = RF 的商品：正常計算 Safety Stock
• RP Type = ND 的商品：使用原始 Safety Stock（不計算）
• RP Type 缺失或其他值：正常計算 Safety Stock
```

#### 版本更新
- 將首頁標題從 v2.3 更新至 v2.4
- 在「系統功能」區塊中新增 v2.4 功能說明

### 4. 結果輸出

#### 輸出欄位
在計算結果中保留 RP Type 相關欄位供審計：
- `RP Type`: 原始 RP Type 值
- `Constraint_Applied`: 清楚標識是否因 RP Type 被跳過
- `Calculation_Mode`: 標註「Skipped (RP Type=ND)」或其他計算模式
- `Notes`: 詳細說明為何使用原始 Safety Stock

## 計算流程

### 標準流程（計算所有 RP Type）
```
1. 讀取輸入數據
2. 執行標準安全庫存計算
3. 輸出結果
```

### 新增流程（僅計算 RF 型）
```
1. 讀取輸入數據
2. 檢查 RP Type 值
   ├─ 如果 RP Type = "ND"
   │  └─ 使用原始 Safety Stock，標記為跳過
   └─ 其他（RF、缺失、其他值）
      └─ 執行標準安全庫存計算
3. 輸出結果
```

## RP Type 值判斷邏輯

| RP Type 值 | 設定：計算全部 | 設定：僅RF | 說明 |
|-----------|--------------|----------|------|
| "RF" | ✅ 計算 | ✅ 計算 | 合法RF值，都計算 |
| "ND" | ✅ 計算 | ❌ 跳過 | ND值在僅RF模式下跳過 |
| 缺失 | ✅ 計算 | ✅ 計算 | 無RP Type信息，不過濾 |
| 其他值 | ✅ 計算 | ✅ 計算 | 非標準值，不過濾 |
| 大小寫混合 | ✅ 計算 | ❌ 跳過* | 統一轉大寫後判斷 |

*例如 "Nd"、"nD" 等都會被轉為 "ND" 進行判斷

## 設定持久化

- 用戶選擇的計算模式保存至 `config/settings.json`
- 下次應用啟動時自動載入上次設定
- 提供「重置設定」按鈕恢復預設值（true）

## 向後相容性

- 預設值為 `true`（計算所有RP Type），保持現有行為
- 舊的 settings.json 缺少此設定時，自動補充為預設值 `true`
- 所有已有的計算邏輯和輸出格式保持不變

## 版本變更紀錄

### 檔案變更清單
1. `config/settings.py` - 新增 `calculate_ss_for_all_rp_types` 參數
2. `config/settings.json` - 新增 `calculate_ss_for_all_rp_types: true` 配置
3. `core/calculator.py` - 在 `calculate_safety_stock()` 方法中新增 RP Type 檢查邏輯
4. `app.py` - 在設定面板新增 RP Type 選項，更新首頁版本號和功能說明

### 測試用例
1. **測試模式 1：計算所有 RP Type**
   - 上傳含 RP Type = "ND" 的數據
   - 驗證 Safety Stock 被正常計算

2. **測試模式 2：僅計算 RF 型**
   - 上傳含 RP Type = "ND" 的數據
   - 驗證結果使用原始 Safety Stock
   - 驗證 Constraint_Applied 標記為 "RP Type Filter (ND)"

3. **設定持久化測試**
   - 切換計算模式
   - 刷新頁面
   - 驗證設定被保存和載入

4. **邊界情況**
   - 無 RP Type 欄位的數據
   - RP Type 為空值的數據
   - RP Type 大小寫混合的數據

## 使用者指南

### 設定位置
在左側邊欄「⚙️ 系統設定」區塊中可找到「RP Type 計算選項」。

### 選項說明
1. **計算所有 RP Type（ND + RF）**
   - 推薦用於需要完整計算的情況
   - 系統不區分 RP Type，都計算 Safety Stock

2. **僅計算 RF 型**
   - 推薦用於只需要 RF 商品安全庫存的情況
   - ND 商品保持原始庫存值

### 關鍵注意事項
- 變更設定后，新的計算將自動套用此設定
- 舊的計算結果不會回溯更新
- 請根據業務需求選擇適當的計算模式
