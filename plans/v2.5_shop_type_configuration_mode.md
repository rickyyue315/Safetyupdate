# 店舖類型配置模式 (Shop Type Configuration Mode)

## 功能概述

店舖類型配置模式是一個全新的安全庫存計算模式，基於 `Safety Stocks Calculation 1.xlsx` 的設計邏輯實現。

此模式**不使用公式計算**，而是根據店舖的「**區域**」+「**店舖等級**」+「**貨場面積**」來查表獲取固定的安全庫存數量。

## 啟用方式

### 1. 在 UI 中啟用

1. 開啟 Streamlit 應用
2. 在左側邊欄的「**店舖類型配置模式**」區域
3. 勾選「**啟用店舖類型配置模式**」

### 2. 在代碼中啟用

```python
from config.settings import Settings

# 建立啟用店舖類型模式的設定
settings = Settings(use_shop_type_mode=True)
```

## 計算邏輯

### 查表公式

```
安全庫存數量 = SHOP_TYPE_SS_CONFIG[區域][店舖等級類別][貨場面積]
```

### 店舖等級類別映射

- **AA, A1, A2, A3** → **A**
- **B1, B2** → **B**
- **C1, C2** → **C**
- **D1** → **D**

## 必要欄位

使用此模式時，輸入資料必須包含以下欄位：

| 欄位名稱 | 別名 | 說明 | 範例 |
|---------|------|------|------|
| **Region** | HK/ MO, HK/MO, 區域 | 店舖所在區域 | HK, MO |
| **Class** | Shop Class, 店舖等級 | 店舖等級 | AA, A1, B1, C1, D1 等 |
| **Shop Size** | 貨場面積, Size | 貨場面積大小 | XL, L, M, S, XS |

> **注意**: 其他標準欄位（Article, Site, Last Month Sold Qty 等）仍然需要，但不用於計算安全庫存數量。

## 配置表

### 香港 (HK)

| 店舖等級 | XL | L | M | S | XS |
|---------|----|----|----|----|-----|
| **A** (AA/A1/A2/A3) | 18 | 18 | 18 | 18 | 18 |
| **B** (B1/B2) | 18 | 18 | 12 | 12 | 12 |
| **C** (C1/C2) | 12 | 12 | 12 | 12 | 0 |
| **D** (D1) | 9 | 9 | 6 | 6 | 6 |

### 澳門 (MO)

| 店舖等級 | XL | L | M | S | XS |
|---------|----|----|----|----|-----|
| **A** (AA/A1/A2/A3) | 24 | 24 | 24 | 24 | 24 |
| **B** (B1/B2) | 18 | 18 | 18 | 12 | 12 |
| **C** (C1/C2) | 12 | 12 | 12 | 12 | 0 |
| **D** (D1) | 9 | 9 | 6 | 6 | 6 |

## 使用範例

### 範例 1: 香港 B2 級店舖，中型面積

**輸入資料**:
- Region: HK
- Class: B2
- Shop Size: M

**計算過程**:
1. 區域 = HK
2. 店舖等級 B2 → 類別 B
3. 貨場面積 = M
4. 查表: SHOP_TYPE_SS_CONFIG["HK"]["B"]["M"] = **12**

**結果**: 安全庫存 = **12 件**

### 範例 2: 澳門 A1 級店舖，超大型面積

**輸入資料**:
- Region: MO
- Class: A1
- Shop Size: XL

**計算過程**:
1. 區域 = MO
2. 店舖等級 A1 → 類別 A
3. 貨場面積 = XL
4. 查表: SHOP_TYPE_SS_CONFIG["MO"]["A"]["XL"] = **24**

**結果**: 安全庫存 = **24 件**

## 輸出欄位

當使用店舖類型配置模式時，輸出會包含以下特殊標記：

| 欄位 | 值 |
|------|-----|
| **Calculation_Mode** | "Shop Type Configuration" |
| **Constraint_Applied** | "店舖類型配置" |
| **Notes** | 詳細說明查表過程 |

範例輸出的 Notes 欄位：
```
計算步驟（店舖類型模式）：
區域: HK, 店舖等級: B2, 貨場面積: M
查表得到固定安全庫存 = 12
```

## CSV 檔案範例

```csv
Article,Site,Class,Last Month Sold Qty,Last 2 Month Sold Qty,Supply Source,MOQ,Original_Safety_Stock,Region,Shop Size
SKU001,HA02,B2,100,150,1,6,10,HK,M
SKU001,HA06,B1,120,180,1,6,12,HK,L
SKU002,HB01,A1,200,300,1,12,20,MO,XL
SKU002,HB04,D1,50,70,2,12,6,MO,M
```

## 與其他模式的關係

### 優先級

當啟用店舖類型配置模式時，系統會**優先使用此模式**，跳過其他計算方式：

1. ✅ **店舖類型配置模式** (如果啟用且資料完整)
2. RP Type 過濾
3. Target Qty 模式
4. 標準模式

### 模式互斥性

- ✅ 可以與 **RP Type 過濾** 共存
- ✅ 與 **Target Qty 模式** 互斥（優先使用店舖類型模式）
- ✅ 與 **標準模式** 互斥（優先使用店舖類型模式）

### 資料缺失處理

如果輸入資料缺少 `Region` 或 `Shop Size` 欄位，系統會自動退回到標準模式進行計算。

## 適用場景

此模式適合以下業務場景：

1. **統一配貨標準**: 公司有固定的店舖配貨政策，按店舖類型配置
2. **簡化計算**: 不需要複雜的公式計算，直接按規則配置
3. **區域差異**: 不同區域（HK/MO）有不同的配貨標準
4. **店舖分級**: 根據店舖等級和面積大小配置不同的安全庫存

## 技術實現

### 核心檔案

1. **[core/constants.py](../../core/constants.py)**
   - `SHOP_TYPE_SS_CONFIG`: 店舖類型配置表
   - `FIELD_REGION`: 區域欄位名稱
   - `FIELD_SHOP_SIZE`: 貨場面積欄位名稱

2. **[config/settings.py](../../config/settings.py)**
   - `use_shop_type_mode`: 店舖類型模式開關

3. **[core/calculator.py](../../core/calculator.py)**
   - `get_shop_type_safety_stock()`: 查表方法
   - `calculate_safety_stock()`: 主計算流程（步驟 0-A）

4. **[app.py](../../app.py)**
   - UI 控制項
   - 使用說明

### 修改點

1. ✅ 新增 `SHOP_TYPE_SS_CONFIG` 配置表（36 個配置項）
2. ✅ 新增 `use_shop_type_mode` 設定參數
3. ✅ 新增 `get_shop_type_safety_stock()` 查表方法
4. ✅ 修改 `calculate_safety_stock()` 主流程，在步驟 0-A 檢查並處理店舖類型模式
5. ✅ 更新 UI 設定面板和說明文檔

## 測試

### 執行測試

```bash
python test_shop_type_mode.py
```

### 測試內容

1. **測試 1**: 店舖類型安全庫存查詢功能（16 個測試案例）
2. **測試 2**: 店舖類型模式完整計算流程
3. **測試 3**: 標準模式不受影響

### 測試資料

- 測試 CSV: `data/input/test_shop_type_mode.csv`
- 9 筆測試資料（涵蓋 HK/MO, A/B/C/D, 各種面積）

## 注意事項

1. **資料完整性**: 必須提供完整的 Region 和 Shop Size 欄位
2. **大小寫**: 系統會自動標準化大小寫，不需要擔心
3. **配置更新**: 如需修改配置表，請編輯 `core/constants.py` 中的 `SHOP_TYPE_SS_CONFIG`
4. **向後兼容**: 此模式完全獨立，不影響現有的標準模式和 Target Qty 模式

## 版本歷史

- **v2.5** (2026-01-31): 新增店舖類型配置模式
  - 基於 `Safety Stocks Calculation 1.xlsx` 實現
  - 支援 HK/MO 兩個區域
  - 支援 5 種貨場面積（XL/L/M/S/XS）
  - 完全獨立的計算模式，不影響現有功能
