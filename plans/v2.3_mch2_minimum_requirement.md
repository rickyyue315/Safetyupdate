# v2.3 更新計劃：MCH2 最低安全庫存要求

## 需求說明

### 背景
在 `Test_28Jan2026.XLSX` 中，當 MCH2 欄位內容為 "0302" 時，安全庫存需滿足以下最低要求：

### MCH2 = 0302 時的最低安全庫存要求

| Shop Class | 最低要求 (件) |
|-----------|------------|
| AA, A1, A2, A3 | >= 12 |
| B1, B2 | >= 10 |
| C1, C2, D1 | >= 6 |

### 實現方式
- 在計算完成後，檢查計算結果的安全庫存數量
- 如果 MCH2 = 0302，比較建議的安全庫存與對應 Shop Class 的最低要求
- 如果建議值低於最低要求，將使用最低要求值
- 在輸出結果中清楚標識此約束條件

## 技術實現計劃

### 1. 常數定義 (`core/constants.py`)

新增 MCH2 最低安全庫存要求映射表：

```python
MCH2_MINIMUM_SS_MAP: Dict[str, Dict[str, int]] = {
    "0302": {
        "AA": 12,
        "A1": 12,
        "A2": 12,
        "A3": 12,
        "B1": 10,
        "B2": 10,
        "C1": 6,
        "C2": 6,
        "D1": 6
    }
}

# 定義 MCH2 欄位常數
FIELD_MCH2 = "MCH2"
```

**重要變更**：將 `FIELD_MCH2` 新增至 `REQUIRED_INPUT_FIELDS` 列表

### 2. 數據處理器 (`core/data_processor.py`)

- 在 `REQUIRED_INPUT_FIELDS` 中新增 `FIELD_MCH2` 為必須欄位
- 在 `clean_data()` 中將 MCH2 轉換為字串類型
- 更新 `COLUMN_NAME_ALIASES` 以支援 MCH2 欄位名稱變體
- 在 `prepare_calculation_data()` 中包含 MCH2 欄位

### 3. 安全庫存計算器 (`core/calculator.py`)

新增方法：
- `apply_mch2_minimum_requirement()`: 根據 MCH2 條件應用最低安全庫存要求
  - 參數：`suggested_ss`, `mch2`, `shop_class`
  - 返回：`(adjusted_ss, mch2_constraint_applied, mch2_value)`

在 `calculate_safety_stock()` 中：
- 接收 MCH2 參數
- 在套用天數上限後調用此方法
- 若啟用 MCH2 約束，在結果中記錄

### 4. 應用程式 (`app.py`)

- 在 UI 中顯示 MCH2 相關提示
- 在計算邏輯中傳遞 MCH2 值
- 在結果欄位中新增 MCH2 約束標識
- 更新版本號至 v2.3

### 5. 結果輸出

在結果中新增欄位：
- `MCH2`: MCH2 值（若存在）
- `MCH2_Minimum_SS_Applied`: 是否應用了 MCH2 最低要求
- `MCH2_Minimum_Required`: 該 Shop Class 的 MCH2 最低要求（若適用）
- `Final_Suggested_Safety_Stock`: 套用 MCH2 約束後的最終建議值

## 計算流程

```
1. 讀取輸入數據（包含 MCH2 欄位）
2. 執行標準安全庫存計算
3. 獲得建議安全庫存值 (Suggested_Safety_Stock)
4. 檢查 MCH2 是否為 "0302"
5. 如果是 "0302"：
   - 根據 Shop Class 查詢最低要求
   - 比較：建議值 vs. 最低要求
   - 若建議值 < 最低要求 → 使用最低要求值
   - 更新約束標識
6. 返回最終結果
```

## 變更影響

### 文件變更
- `core/constants.py`: 新增 MCH2 映射表
- `core/calculator.py`: 新增 MCH2 約束方法
- `core/data_processor.py`: 支援 MCH2 欄位
- `app.py`: 更新版本號和 UI

### 後向相容性

**重要**：由於 MCH2 是新的必須欄位，現有的輸入檔案需要新增此欄位才能使用。

- 若 MCH2 值不是 "0302"，不應用最低要求約束
- 若 MCH2 為空或無法識別，按標準計算邏輯進行
- 現有的 MF、MOQ、天數上限等約束邏輯保持不變
- 此更新為漸進式升級，建議在系統說明中通知使用者需要更新輸入檔案格式

## 測試策略

### 測試案例

1. **MCH2 = 0302 / Class AA 建議值 > 12**
   - 預期：使用建議值

2. **MCH2 = 0302 / Class AA 建議值 = 8**
   - 預期：使用最低要求值 12

3. **MCH2 = 0302 / Class B1 建議值 = 7**
   - 預期：使用最低要求值 10

4. **MCH2 = 0302 / Class D1 建議值 = 3**
   - 預期：使用最低要求值 6

5. **MCH2 ≠ 0302 / 任何 Class**
   - 預期：使用標準計算結果，不應用最低要求

6. **MCH2 為空或不存在**
   - 預期：使用標準計算結果，不應用最低要求

### 驗證清單
- ✅ 從 Excel 檔案正確讀取 MCH2 欄位
- ✅ MCH2 欄位值正確判斷
- ✅ 最低要求值正確應用
- ✅ 約束標識正確記錄
- ✅ 支撐天數正確重新計算
- ✅ Excel 輸出包含 MCH2 相關欄位
- ✅ Notes 中清楚說明 MCH2 約束

## 實施順序

1. 更新 `core/constants.py`
2. 更新 `core/calculator.py`
3. 更新 `core/data_processor.py`
4. 更新 `app.py`
5. 建立測試用例
6. 驗證 Test_28Jan2026.XLSX
7. 綜合測試與驗證
